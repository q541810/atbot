## 目标
- 统一并优化配置文件读取流程，避免重复解析与散落的依赖。
- 新增结构化、可读性强的错误报告：精确指出错误位置（文件/段/键/期望类型）、现值、以及修复建议。
- 在不引入新依赖的前提下完成核心能力，保留可选的 schema 库（如 pydantic）方案备选。

## 当前情况（基于代码阅读）
- 读取位置：
  - `c:\porjecket\my\atbot\read_config.py`：
    - `load_adapter_config` 读取 `config/adapter_config.toml`（toml）。
    - `load_bot_config` 读取 `config/bot_config.toml`（toml）。
    - `load_model_config` 读取 `.env` 并汇总 provider 的 `url/key` 映射。
    - `load_adaptive_model_config` 基于 `bot_config.toml` 里的 provider 与 `.env` 映射拼装运行时模型配置。
  - 使用点：`c:\porjecket\my\atbot\bot.py:20–41,48,50–55` 启动时集中读取；`c:\porjecket\my\atbot\log.py:18–23` 根据 `调试模式` 控制 debug；`c:\porjecket\my\atbot\llm\send_message.py:23–31` 再次读取 bot 基本信息。
- 错误处理：
  - TOML 缺失/语法错误未统一捕获，可能直接抛 `FileNotFoundError` 或 `toml.TomlDecodeError` 并在 `bot.py` 顶层以笼统错误消息结束。
  - `.env` 缺少 provider 时仅记录 `log.error`，继续返回空字符串，不抛异常。
  - 未做键存在/类型校验，运行期可能触发 `KeyError` 或类型不匹配。

## 改进方案
### 1) 统一入口与缓存
- 新增 `ConfigLoader`（单文件或包）：集中管理三类源（TOML：adapter/bot；dotenv：env），首次读取后缓存，提供只读访问 API。
- 公开方法：`load_all() / get_adapter() / get_bot() / get_models()`；确保其他模块不再直接解析文件。

### 2) 健壮解析与异常封装
- TOML 解析：捕获 `FileNotFoundError`、`toml.TomlDecodeError`、`OSError`，封装为统一的 `ConfigError`。
- dotenv：加载后校验必需变量（按已启用的 provider），缺失时产生可操作错误而非静默空值。
- 提供 `collect_errors=True` 模式：尽可能收集同一轮次的多个错误，一次性输出。

### 3) 结构化校验（无依赖优先）
- 轻量校验器：
  - 必填键：按现有 `bot_config.toml` 的结构列出关键路径（如 `bot.调试模式`、`model.replyer_1.provider`、`napcat_server.host` 等）。
  - 类型校验：`int/float/str/bool/list` 基本类型检查；范围校验（如 `回复兴趣 0–10`）。
  - 条件校验：当 `model.picture.switch=true` 时必须存在对应 provider 的 `url/key`。
- 可选：如允许新依赖，提供 `pydantic` 方案，自动生成更严格的校验与更清晰的类型错误。

### 4) 错误信息设计（精确+可修复）
- 自定义异常 `ConfigError` 字段：`file`、`section`、`key`、`expected`、`actual`、`hint`、`example`。
- 输出格式示例：
  - `配置错误: 文件=config/bot_config.toml 段=[model.replyer_1] 键=maxtoken 期望=int 实际="64"。修复: 将值改为整数。例如: maxtoken = 64`
  - `缺失环境变量: 文件=config/.env provider=siliconflow 缺少=SILICONFLOW_KEY。修复: 在 .env 添加 "SILICONFLOW_KEY=你的key"`
- 若无法定位行号，明确提供“段路径与键名”并给出最小可复制片段，保证用户可直接改。

### 5) 修复建议生成
- TOML：当键不存在或类型错，给出完整示例片段，放入对应 `[section]` 下；当值越界，给出合法范围。
- `.env`：根据 `provider` 生成需要的 `PROVIDER_URL/KEY` 名字与示例值。

### 6) 行为策略
- 启动策略：
  - 致命错误（缺主文件、解析失败、必需键缺失、开启特性缺关键 env）→ 收敛为一份详细错误清单，打印后退出（返回非零状态）；
  - 非致命（可回退默认值的项目）→ 打印警告并继续。
- 日志对齐：复用 `log.py`，在 `debug` 模式下输出更多上下文（但不暴露敏感 key）。

### 7) 具体改动
- 修改：`c:\porjecket\my\atbot\read_config.py`
  - 提取/重构为 `ConfigLoader`，实现缓存、统一异常、校验与组装。
  - 将现有 `load_*` 函数改为调用 `ConfigLoader` 或保留为 wrapper（向后兼容）。
- 修改：`c:\porjecket\my\atbot\bot.py:20–41`
  - 用 `ConfigLoader.load_all()` 取配置；捕获 `ConfigError` 集合，友好打印并退出；去除对空值的后续假设。
- 修改：`c:\porjecket\my\atbot\log.py:18–23`
  - 从 `ConfigLoader` 读取 `调试模式`，避免重复解析。
- 新增：`c:\porjecket\my\atbot\config\errors.py`
  - 定义 `ConfigError`、`ConfigErrorBundle`（多错误集合）。
- 新增：`c:\porjecket\my\atbot\scripts\validate_config.py`
  - 独立校验脚本：打印详细错误与修复建议，供本地快速检查。
- 可选新增：`tests/test_config.py`
  - 针对典型错误场景的单测（缺文件、语法错、缺键、类型错、env 缺失）。

### 8) 示例输出
- TOML 类型错误：
  - `配置错误: 文件=config/bot_config.toml 段=[bot] 键=调试模式 期望=bool 实际="false"(str)。修复: 使用布尔字面量。例如: 调试模式 = false`
- 缺少 provider 设置：
  - `缺失环境变量: 文件=config/.env provider=deepseek 缺少=DEEPSEEK_KEY。修复: 添加行 "DEEPSEEK_KEY=xxxx"；或在 bot_config.toml 中将相关模型开关设为 false`
- 缺少键：
  - `缺少键: 文件=config/adapter_config.toml 段=[napcat_server] 键=port。修复: 添加 "port = 8080"（整数）`

### 9) 验证与回归
- 本地运行 `scripts/validate_config.py`（在不启动 bot 的情况下），确保所有错误能被精准定位与给出建议。
- 启动 `bot.py`，验证致命错误会在启动阶段阻止运行并打印清单；警告级错误不影响主流程。
- 保持向后兼容：现有 `load_*` API 不破坏；外部模块无需改动调用签名。

### 10) 依赖与安全
- 默认不新增三方依赖；如需 `pydantic`，再单独确认。
- 不在日志中输出完整 `*_KEY` 值，只显示提示与掩码。

## 请确认
- 是否采用“无新依赖”的实现方案？若同意，我将按以上改动实施并提交对应代码与校验脚本。